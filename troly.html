<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tr·ª£ l√Ω ·∫£o</title>
<style>
    :root {
        --bg: #0b0b0f;
        --text: #f1f1f1;
        --accent: #1a73e8;
        --bubble-user: #1f1f24;
        --bubble-ai: #141417;
        --border: #2a2a30;
        --radius: 16px;
        --shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        font-family: "Poppins", sans-serif;
    }

    .code{display:block;background:linear-gradient(180deg,#0f172a,#061021);color:#d1e7ff;padding:12px;border-radius:8px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Roboto Mono",monospace;font-size:13px;overflow:auto}

    body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    header img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
    }

    header h1 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
    }

    main {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        scroll-behavior: smooth;
    }

    .message {
        max-width: 75%;
        padding: 0.8rem 1rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        animation: fadeIn 0.3s ease-in-out;
        line-height: 1.4;
        white-space: pre-line;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .ai { align-self: flex-start; background: var(--bubble-ai); border: 1px solid var(--border); }
    .user { align-self: flex-end; background: var(--bubble-user); }

    .input-area {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.6rem 1rem;
        border-top: 1px solid var(--border);
        background: var(--bg);
    }

    .input-area input {
        flex: 1;
        max-width: 700px;
        padding: 0.55rem 1rem;
        background: var(--bubble-user);
        color: var(--text);
        border: none;
        border-radius: var(--radius);
        outline: none;
        font-size: 0.9rem;
        height: 38px;
    }

    .input-area button {
        background: var(--accent);
        border: none;
        color: #fff;
        margin-left: 0.4rem;
        padding: 0.55rem 1rem;
        border-radius: var(--radius);
        cursor: pointer;
        transition: background 0.3s;
        height: 38px;
    }

    .input-area button:hover { background: #155ab6; }

    .typing {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 0.4rem 0.8rem;
        border-radius: var(--radius);
        background: var(--bubble-ai);
        border: 1px solid var(--border);
        max-width: fit-content;
    }

    .dot {
        width: 6px; height: 6px; border-radius: 50%;
        background: #ccc; opacity: 0.4; animation: blink 1s infinite;
    }

    .dot:nth-child(2){animation-delay:.2s;} .dot:nth-child(3){animation-delay:.4s;}
    @keyframes blink{0%,80%,100%{opacity:.2;transform:translateY(0);}40%{opacity:1;transform:translateY(-4px);}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
    ::-webkit-scrollbar{width:6px;}::-webkit-scrollbar-thumb{background:#333;border-radius:3px;}
</style>
</head>
<body>
<header>
    <img src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" alt="Tr·ª£ l√Ω ·∫£o" />
    <h1>Th·∫ßn ƒë√®n</h1>
    <button id="clearData" style="margin-left:auto;background:#d33;border:none;color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;">üßπ X√≥a t·∫•t c·∫£ ƒë√£ d·∫°y</button>
</header>

<main id="chat">
    <div class="message ai">
        Xin ch√†o üëã T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?
        <div class="code">H√£y th·ª≠ h·ªèi t√¥i:
        - "Th·ªùi ti·∫øt h√¥m nay th·∫ø n√†o?"
        - "K·ªÉ cho t√¥i m·ªôt c√¢u chuy·ªán c∆∞·ªùi."
        - "T√¥i c·∫ßn gi√∫p ƒë·ª° v·ªõi to√°n h·ªçc."
        - "G·ª£i √Ω c√¥ng th·ª©c n·∫•u ƒÉn."
        - "H·ªçc t·ª´ n√†y"
        </div>
    </div>
</main>

<div class="input-area">
    <input type="text" id="userInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
    <button onclick="sendMessage()">G·ª≠i</button>
</div>

<script>
    const wkey = "https://wttr.in/Hanoi?format=j1";
    const chat = document.getElementById("chat");
    const input = document.getElementById("userInput");
    const clearBtn = document.getElementById("clearData");

    let learnState = 0;
    let userQuestion = "";
    let memory = loadLearned();

    // ----- LocalStorage -----
    function loadLearned() {
        return JSON.parse(localStorage.getItem("learned") || "{}");
    }
    function saveLearned(obj) {
        localStorage.setItem("learned", JSON.stringify(obj));
    }
    function clearLearned() {
        localStorage.removeItem("learned");
        memory = {};
    }

    // üßπ N√∫t xo√° d·ªØ li·ªáu
    clearBtn.onclick = () => {
        clearLearned();
        const aiMsg = document.createElement("div");
        aiMsg.className = "message ai";
        aiMsg.textContent = "üßπ ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu h·ªçc.";
        chat.appendChild(aiMsg);
        chat.scrollTop = chat.scrollHeight;
    };

    // üí¨ G·ª≠i tin nh·∫Øn
    async function sendMessage() {
        const text = input.value.trim();
        if (!text) return;

        const userMsg = document.createElement("div");
        userMsg.className = "message user";
        userMsg.textContent = text;
        chat.appendChild(userMsg);
        chat.scrollTop = chat.scrollHeight;
        input.value = "";

        const typing = document.createElement("div");
        typing.className = "typing";
        typing.innerHTML = `<span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
        chat.appendChild(typing);
        chat.scrollTop = chat.scrollHeight;

        setTimeout(async () => {
            typing.remove();
            const aiMsg = await ask(text);
            chat.appendChild(aiMsg);
            chat.scrollTop = chat.scrollHeight;
        }, 1000);
    }

    input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
    });

    // üß≠ H√†m ph·∫£n h·ªìi ch√≠nh
    async function ask(query) {
        const aiMsg = document.createElement("div");
        aiMsg.className = "message ai";

        if (!query) {
            aiMsg.textContent = "ü§ñ B·∫°n ch∆∞a nh·∫≠p g√¨ c·∫£.";
            return aiMsg;
        }

        const q = query.toLowerCase();
        const nq = query.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

        // Tho√°t h·ªçc
        if (q === "/huy" && learnState > 0) {
            learnState = 0;
            aiMsg.textContent = "‚ùå ƒê√£ tho√°t ch·∫ø ƒë·ªô h·ªçc.";
            return aiMsg;
        }

        // B·∫Øt ƒë·∫ßu h·ªçc
        if (/\b(hoc tu nay|day hoc|day tu|hoc tu|day toi|hoc toi)\b/.test(nq)) {
            learnState = 1;
            aiMsg.textContent = "üìö ƒêang v√†o ch·∫ø ƒë·ªô h·ªçc. H√£y nh·∫≠p c√¢u h·ªèi b·∫°n mu·ªën d·∫°y t√¥i. (/huy ƒë·ªÉ tho√°t)";
            return aiMsg;
        }

        // Ghi nh·∫≠n c√¢u h·ªèi
        if (learnState === 1) {
            userQuestion = query;
            learnState = 2;
            aiMsg.textContent = "‚úèÔ∏è Ghi nh·∫≠n c√¢u h·ªèi. Gi·ªù h√£y g·ª≠i c√¢u tr·∫£ l·ªùi cho c√¢u h·ªèi n√†y.";
            return aiMsg;
        }

        // Ghi nh·∫≠n c√¢u tr·∫£ l·ªùi
        if (learnState === 2) {
            memory[userQuestion.toLowerCase()] = query;
            saveLearned(memory);
            learnState = 0;
            aiMsg.textContent = "‚úÖ ƒê√£ h·ªçc th√†nh c√¥ng!";
            return aiMsg;
        }

        for (const key in memory) {
            if (q.includes(key.toLowerCase())) {
                aiMsg.textContent = memory[key];
                return aiMsg;
            }
        }

        // Th·ªùi ti·∫øt
        if (q.includes("th·ªùi ti·∫øt")) {
            try {
                const response = await fetch(wkey);
                const data = await response.json();
                const current = data.current_condition[0];
                const temp = current.temp_C;
                const desc = current.weatherDesc[0].value;
                const windDir = current.winddir16Point;
                const windSpeed = current.windspeedKmph;
                let icon = "‚òÄÔ∏è";
                const descLower = desc.toLowerCase();
                if (descLower.includes("m∆∞a")) icon = "üåßÔ∏è";
                else if (descLower.includes("m√¢y")) icon = "‚òÅÔ∏è";
                else if (descLower.includes("b√£o") || descLower.includes("storm")) icon = "‚õàÔ∏è";
                aiMsg.innerHTML = `
                    <strong>Th·ªùi ti·∫øt hi·ªán t·∫°i:</strong><br>
                    ${icon} ${desc}<br>
                    üå°Ô∏è <b>Nhi·ªát ƒë·ªô:</b> ${temp}¬∞C<br>
                    üå¨Ô∏è <b>Gi√≥:</b> ${windDir}, ${windSpeed} km/h
                `;
                return aiMsg;
            } catch {
                aiMsg.textContent = "‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt. Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng nh√©.";
                return aiMsg;
            }
        }

        // Gi·ªù hi·ªán t·∫°i
        if (q.includes("gi·ªù") && q.includes("m·∫•y") || q.includes("th·ªùi gian") || q.includes("b√¢y gi·ªù")) {
            const now = new Date();
            aiMsg.textContent = `üïí B√¢y gi·ªù l√† ${now.toLocaleTimeString()} ng√†y ${now.toLocaleDateString()}.`;
            return aiMsg;
        }

        if (q.includes("k·ªÉ chuy·ªán c∆∞·ªùi") || q.includes("n√≥i chuy·ªán c∆∞·ªùi") || q.includes("m·ªôt c√¢u chuy·ªán c∆∞·ªùi")) {
            const jokes = [
                "T·∫°i sao con g√† bƒÉng qua ƒë∆∞·ªùng? ƒê·ªÉ sang b√™n kia!",
                "T·∫°i sao m√°y t√≠nh kh√¥ng th·ªÉ ƒë√°nh nhau? V√¨ n√≥ s·ª£ b·ªã virus!",
                "T·∫°i sao c√° kh√¥ng bao gi·ªù l√†m vi·ªác? V√¨ ch√∫ng lu√¥n b∆°i l·ªôi!",
            ];
            const randomJoke = jokes[Math.floor(Math.random() * jokes.length)];
            aiMsg.textContent = `üòÇ ${randomJoke}`;
            return aiMsg;
        }

        if (q.includes("ch√†o")) {
            const greetings = [
                "Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?",
                "Xin ch√†o! R·∫•t vui ƒë∆∞·ª£c g·∫∑p b·∫°n.",
                "T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?",
            ];
            const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
            aiMsg.textContent = `${randomGreeting}`;
            return aiMsg;
        }

        if (q.includes("c√¥ng th·ª©c n·∫•u ƒÉn") || q.includes("g·ª£i √Ω m√≥n ƒÉn") || q.includes("m√≥n ƒÉn")) {
            const recipes = [
                "üç≤ G·ª£i √Ω m√≥n ƒÉn: M√¨ x√†o rau c·ªß - nhanh g·ªçn v√† ngon mi·ªáng!",
                "üçõ G·ª£i √Ω m√≥n ƒÉn: C∆°m chi√™n d∆∞∆°ng ch√¢u - ƒë·∫ßy ƒë·ªß dinh d∆∞·ª°ng v√† h∆∞∆°ng v·ªã.",
                "ü•ó G·ª£i √Ω m√≥n ƒÉn: Salad tr·ªôn - t∆∞∆°i m√°t v√† d·ªÖ l√†m.",
            ];
            const randomRecipe = recipes[Math.floor(Math.random() * recipes.length)];
            aiMsg.textContent = randomRecipe;
            return aiMsg;
        }

        // M·∫∑c ƒë·ªãnh
        const random_else = Math.floor(Math.random() * 3);
        aiMsg.textContent =
            random_else === 0
                ? "T√¥i v·∫´n ƒëang h·ªçc h·ªèi ƒë·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi c·ªßa b·∫°n."
                : random_else === 1
                ? "T√¥i ch∆∞a bi·∫øt c√¢u n√†y. B·∫°n c√≥ th·ªÉ d·∫°y t√¥i b·∫±ng c√°ch g√µ 'd·∫°y h·ªçc'."
                : "T√¥i ch∆∞a c√≥ th√¥ng tin. H√£y th·ª≠ d·∫°y t√¥i nh√©!";
        return aiMsg;
    }
</script>
</body>
</html>
